pipeline {
    agent any
    parameters {
        string(name: 'BRANCH_NAME', defaultValue: 'develop', description: 'ビルドするブランチ名')
    }
    stages {
        stage('build') {
            parallel {
                stage('windows') {
                    steps {
                        node('master') {
                            deleteDir()
                            git url: 'https://github.com/ingen084/KyoshinEewViewerIngen.git', branch: BRANCH_NAME

                            bat 'publish_updater_custom.bat Windows win10-x64 merged true'

                            archiveArtifacts(artifacts: 'tmp/KyoshinEewViewer_ingen_*.zip', onlyIfSuccessful: true)
                        }
                    }
                }
                stage('linux') {
                    steps {
                        node('lxsv1') {
                            deleteDir()
                            git url: 'https://github.com/ingen084/KyoshinEewViewerIngen.git', branch: BRANCH_NAME

                            sh 'chmod +x publish_updater_custom.sh;./publish_updater_custom.sh Linux linux-x64 merged true'

                            archiveArtifacts(artifacts: 'tmp/KyoshinEewViewer_ingen_*.zip', onlyIfSuccessful: true)
                        }
                    }
                }
            }
        }
        stage('notify discord') {
            steps {
                withCredentials([string(credentialsId: 'DISCORD_WEBHOOK', variable: 'WebhookUrl')]) {
                    discordSend(description: "updator build completed!", footer: "Jenkins", link: env.BUILD_URL, result: currentBuild.currentResult, title: "${env.JOB_NAME}#${env.BUILD_NUMBER}", webhookURL: WebhookUrl)
                }
            }
        }
    }
}
